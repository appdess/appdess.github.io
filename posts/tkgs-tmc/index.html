<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.78.2" />
    <meta name="description" content="Provision your Tanzu Kubernetes Clusters from TMC">
<meta name="author" content="Alexander Dess">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    <title>TMC and vSphere with Tanzu - alexdess.cloud</title>

    
    <link href="/css/nucleus.css?1607011983" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1607011983" rel="stylesheet">
    <link href="/css/hybrid.css?1607011983" rel="stylesheet">
    <link href="/css/featherlight.min.css?1607011983" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1607011983" rel="stylesheet">
    <link href="/css/auto-complete.css?1607011983" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1607011983" rel="stylesheet">
    <link href="/css/theme.css?1607011983" rel="stylesheet">
    <link href="/css/hugo-theme.css?1607011983" rel="stylesheet">
    
    <link href="/css/theme-blue.css?1607011983" rel="stylesheet">
    
    <link href="/css/foo.css?1607011983" rel="stylesheet"><link href="/css/bar.css?1607011983" rel="stylesheet">

    <script src="/js/jquery-3.3.1.min.js?1607011983"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/posts/tkgs-tmc/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://alexdess.cloud/">
    <img src="/images/favicon2.png">
  </a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1607011983"></script>
<script type="text/javascript" src="/js/auto-complete.js?1607011983"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/alexdess.cloud";
    
</script>
<script type="text/javascript" src="/js/search.js?1607011983"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/posts/" title="Posts" class="dd-item
        parent
        
        
        ">
      <a href="/posts/">
          Posts
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/posts/tkgs-tmc/" title="TMC and vSphere with Tanzu" class="dd-item
        parent
        active
        
        ">
      <a href="/posts/tkgs-tmc/">
          TMC and vSphere with Tanzu
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/posts/tmconvmc/" title="TMC - Tanzu Mission Control" class="dd-item
        
        
        
        ">
      <a href="/posts/tmconvmc/">
          TMC - Tanzu Mission Control
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/posts/prometheus/" title="Prometheus - From Metrics to Insights" class="dd-item
        
        
        
        ">
      <a href="/posts/prometheus/">
          Prometheus - From Metrics to Insights
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/posts/tkgvmc/" title="TKG on VMC" class="dd-item
        
        
        
        ">
      <a href="/posts/tkgvmc/">
          TKG on VMC
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/posts/appmodernization/" title="App modernization with VMC" class="dd-item
        
        
        
        ">
      <a href="/posts/appmodernization/">
          App modernization with VMC
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/posts/clusterapivmc/" title="K8s ClusterAPI" class="dd-item
        
        
        
        ">
      <a href="/posts/clusterapivmc/">
          K8s ClusterAPI
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/posts/govc/" title="GOVC" class="dd-item
        
        
        
        ">
      <a href="/posts/govc/">
          GOVC
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li>
                  <a class="padding" href="https://twitter.com/dessCloud"><i class='fab fa-fw fa-twitter'></i> Twitter</a>
              </li>
          
              <li>
                  <a class="padding" href="https://www.linkedin.com/in/alexander-dess-00101010/"><i class='fab fa-fw fa-linkedin'></i> Linkedin</a>
              </li>
          
              <li>
                  <a class="padding" href="https://github.com/appdess"><i class='fab fa-fw fa-github'></i> GitHub</a>
              </li>
          
              <li>
                  <a class="padding" href="https://alexdess.cloud/tags"><i class='fas fa-tags'></i> Tags</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      Built with <i class="fas fa-heart"></i>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                   TMC and vSphere with Tanzu
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#provision-and-manage-your-tanzu-kubernetes-clusters-with-tmc">Provision and Manage your Tanzu Kubernetes Clusters with TMC</a></li>
        <li><a href="#prepare-the-vsphere-with-tanzu-environment">Prepare the vSphere with Tanzu Environment</a></li>
        <li><a href="#create-a-tanzu-kubernetes-cluster-from-tanzu-mission-control">Create a Tanzu Kubernetes Cluster from Tanzu Mission Control</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
<div class="tags">

  <a class="tag-link" href="/tags/automation">Automation</a>

  <a class="tag-link" href="/tags/vmc">VMC</a>

  <a class="tag-link" href="/tags/k8s">K8s</a>

  <a class="tag-link" href="/tags/tmc">TMC</a>

</div>

        </div>
        
        <div id="body-inner">
          
            <h1>
              
              TMC and vSphere with Tanzu
            </h1>
          

        



	<h3 id="provision-and-manage-your-tanzu-kubernetes-clusters-with-tmc">Provision and Manage your Tanzu Kubernetes Clusters with TMC</h3>
<p>With the recent enhancement Tanzu Mission Control provides an integration between the Tanzu Kubernetes Grid Service running on vSphere 7 and the centralized control plane &ldquo;Tanzu Mission Control&rdquo; running on VMware Cloud.
With the new update of Tanzu Mission Control it is possible to register an existing vSphere Supervisor Cluster in TMC which enables you to provision and lifecycle new Kubernetes Clusters from TMC directly. Further support for VMware Cloud on AWS and Azure is on the roadmap and should be available soon. Right now you can still manage those Clusters with Tanzu Mission Control by attaching them. The process is described <a href="https://alexdess.cloud/posts/tmconvmc/">here</a>.</p>
<!-- raw HTML omitted -->
<p><strong>To follow this tutorial you will need:</strong></p>
<ul>
<li><a href="https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html">A vSphere with Tanzu Environment</a></li>
<li><a href="https://console.cloud.vmware.com/">Access to Tanzu Mission Control</a></li>
<li>An espresso or a glass of red wine ;)</li>
</ul>
<p>I provisioned my vSphere with Tanzu Lab <a href="https://www.virtuallyghetto.com/2020/11/complete-vsphere-with-tanzu-homelab-with-just-32gb-of-memory.html">based on the Article from my colleague William Lam</a>. The article provides a link to his github repo and really helps you to ramp up a vSphere with Tanzu lab with minimum resources and effort. If you have an existing VMware Cloud organization you can request access to TMC directly from the console. If not please reach out to VMware in order to request the activation.</p>
<p><strong>First we logon to Tanzu Mission Control and register our vSphere Supervisor Cluster</strong></p>
<p>Navigate to <strong>Administration</strong> &gt; <strong>Management Clusters</strong> and then click on the <strong>Register Management Cluster</strong> button in the TMC-UI.</p>
<p><img src="../tkgs-tmc/images/register1.png?classes=shadow&amp;width=50pc" alt=""></p>
<p><strong>On the Register pane, copy the provided registration URL</strong></p>
<p><img src="../tkgs-tmc/images/register2.png?classes=shadow&amp;width=50pc" alt=""></p>
<h3 id="prepare-the-vsphere-with-tanzu-environment">Prepare the vSphere with Tanzu Environment</h3>
<p><strong>Next we need to login to our Supervisor Cluster</strong></p>
<p>My Supervisor Cluster Endpoint IP is <strong>&ldquo;10.10.0.64&rdquo;</strong> and my vSphere Namespace is <strong>&ldquo;adess1&rdquo;</strong>.
<img src="../tkgs-tmc/images/vsphere-ns.png?classes=shadow&amp;width=30pc" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># login to the Supervisor Cluster</span>
$ kubectl-vsphere login --vsphere-username administrator@vsphere.local --server<span style="color:#f92672">=</span>10.10.0.64 --insecure-skip-tls-verify

<span style="color:#75715e"># Setting the context</span>
$ kubectl config use-context adess1

<span style="color:#75715e"># checking for the tmc-namespace</span>
$ k get ns | grep tmc
svc-tmc-c8                                  Active

</code></pre></div><h4 id="register-the-agent">Register the Agent</h4>
<p>We need to register our Supervisor Cluster on TMC and we will achieve this by installing the neccessary agents on it. Therefore we are going to create a file called &ldquo;registration.yaml&rdquo; which will take care about the agent install. Replace the values for your namespace which is &ldquo;svc-tmc-c8&rdquo; and &ldquo;registrationLink&rdquo; which is &ldquo;<a href="https://vmcsetemea.tmc.cloud.vmware.com/installer?id=8fa6dd346a62a25cc64aa82ec49caef652995c9925c3a6b26b8b9261d626a2d5&amp;source=registration%22">https://vmcsetemea.tmc.cloud.vmware.com/installer?id=8fa6dd346a62a25cc64aa82ec49caef652995c9925c3a6b26b8b9261d626a2d5&amp;source=registration&quot;</a> in my example with your values. For additional configuration please have a look at the <a href="https://kb.vmware.com/s/article/80727">official VMware KB.</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#ae81ff">$ cat registration.yaml</span>
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">installers.tmc.cloud.vmware.com/v1alpha1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">AgentInstall</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tmc-agent-installer-config</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">svc-tmc-c8</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">operation</span>: <span style="color:#ae81ff">INSTALL</span>
  <span style="color:#f92672">registrationLink</span>: <span style="color:#ae81ff">https://vmcsetemea.tmc.cloud.vmware.com/installer?id=8fa6dd346a62a25cc64aa82ec49caef652995c9925c3a6b26b8b9261d626a2d5&amp;source=registration</span>

</code></pre></div><p><strong>Apply the registration file on your Cluster:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ k apply -f registration.yaml
agentinstall.installers.tmc.cloud.vmware.com/tmc-agent-installer-config created
</code></pre></div><p><strong>Wait till the following command outputs the status &ldquo;INSTALLED&rdquo;:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl -n svc-tmc-c8 describe agentinstall tmc-agent-installer-config
Manager:         tmc-agent-installer
...
...
  Operation:          INSTALL
  Registration Link:  https://vmcsetemea.tmc.cloud.vmware.com/installer?id<span style="color:#f92672">=</span>8fa6dd346a62a25cc64aa82ec49caef652995c9925c3a6b26b8b9261d626a2d5&amp;source<span style="color:#f92672">=</span>registration
Status:
  Message:  successfully applied the registration link
  Status:   INSTALLED
Events:     &lt;none&gt;
</code></pre></div><p><strong>After this is complete you should be able to see the vSphere Supervisor Cluster registered in Tanzu Mission Control as well:</strong>
<img src="../tkgs-tmc/images/mgmt-cluster.png?classes=shadow&amp;width=70pc" alt=""></p>
<p>We have successfully registered our vSphere Supervisor Cluster with Tanzu Mission Control. We see that our Workload Clusters which are already provisioned have been discovered. From now on we can leverage Tanzu Mission Control to deploy new Tanzu Kubernetes Clusters on our On Prem vSphere Environment.</p>
<h3 id="create-a-tanzu-kubernetes-cluster-from-tanzu-mission-control">Create a Tanzu Kubernetes Cluster from Tanzu Mission Control</h3>
<p><strong>From now on we can create Clusters from Tanzu Mission Control on our vSphere with Tanzu enabled Cluster.</strong>
When you go back to &ldquo;Clusters&rdquo; and hit the &ldquo;CREATE CLUSTER&rdquo; button you will notice, that there is a new option to create Clusters now on our vSphere based TKGs Environment.
<img src="../tkgs-tmc/images/new-tkgs.png?classes=shadow&amp;width=40pc" alt="">
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted --></p>
<p>We are going to create a new Cluster called <strong>&ldquo;tmc-tkg&rdquo;</strong> and first we need to select our Supervisor Cluster and the corresponding Namespace:
<img src="../tkgs-tmc/images/create1.png?classes=shadow&amp;width=40pc" alt=""></p>
<p><strong>Next we will assign a Cluster name and attach it to a Cluster Group. If you want to learn more about Cluster Groups and Namespaces I recommend to checkout my <a href="https://alexdess.cloud/posts/tmconvmc/">previous post about Tanzu Mission Control.</a></strong>
<img src="../tkgs-tmc/images/create2.png?classes=shadow&amp;width=40pc" alt=""></p>
<p>In the configuration step we can select our <strong>K8s Version</strong>, <strong>CIDR-Ranges</strong> and the <strong>Storage classes</strong> which we want to use. You can also select a default storage class in case you are working with multiple storage classes in your environment.
<img src="../tkgs-tmc/images/create3.png?classes=shadow&amp;width=40pc" alt=""></p>
<p>In Step 4 we can select our <strong>Control Plane instance types</strong> and whether we want a highly available <strong>Production</strong> or a single node control plane for a <strong>Development</strong> Cluster.<!-- raw HTML omitted -->
This equals the &ldquo;Virtual Machine Class&rdquo; which you can set when deploying a Tanzu Kubernetes Cluster in the yaml file. For more insights regarding machine classes <a href="https://docs.vmware.com/en/VMware-vSphere/7.0/vmware-vsphere-with-tanzu/GUID-7351EEFF-4EF0-468F-A19B-6CEA40983D3D.html">please have a look here.</a>
<img src="../tkgs-tmc/images/create4.png?classes=shadow&amp;width=40pc" alt=""></p>
<p>In Step 5 we can select our <strong>Worker instance types</strong> and the <strong>Storage class</strong> which we want to use.
<img src="../tkgs-tmc/images/create5.png?classes=shadow&amp;width=40pc" alt=""></p>
<p>That´s it. Let´s hit the <strong>&ldquo;CREATE CLUSTER&rdquo;</strong> Button and wait for the provisioning to happen.
<img src="../tkgs-tmc/images/cluster-creation-tmc.png?classes=shadow&amp;width=40pc" alt=""></p>
<p><strong>Provisioning starts seconds later in our vSphere with Tanzu Environment:</strong>
<img src="../tkgs-tmc/images/cluster-creation-vsphere.png?classes=shadow&amp;width=30pc" alt=""></p>
<p>After the provisioning is finsihed we see that our Cluster is healthy in TMC and we can now logon to the new cluster. Hit the button <strong>&ldquo;Actions&rdquo;</strong> and select <strong>&ldquo;Access this cluster&rdquo;</strong> to retreive the kubeconfig.
<img src="../tkgs-tmc/images/tkc-tmc-access.png?classes=shadow&amp;width=40pc" alt=""></p>
<p>A huge improvement is the integration with IAM when you provision a Cluster from TMC. We are now able to retrieve the corresponding kubeconfig file directly from Tanzu Mission Control which makes it easier for different teams to gain access to this Cluster.
<img src="../tkgs-tmc/images/tkc-tmc-created.png?classes=shadow&amp;width=30pc" alt=""></p>
<p>I have downloaded the kubeconfig file which contains the secret and can now use it to interact with the provisioned Cluster:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl --kubeconfig<span style="color:#f92672">=</span>/Users/adess/Downloads/kubeconfig-tmc-tkg.yml get namespaces
NAME                           STATUS   AGE
default                        Active   147m
kube-node-lease                Active   147m
kube-public                    Active   147m
kube-system                    Active   147m
vmware-system-auth             Active   147m
vmware-system-cloud-provider   Active   147m
vmware-system-csi              Active   147m
vmware-system-tmc              Active   147m
</code></pre></div><p><strong>If you are working with the kubectl-vsphere plugin you can still use the vsphere-kubectl like for any other Tanzu Kubernetes Cluster on vSphere to authenticate.</strong></p>
<p>Below I am running the authentication process via the kubectl-vsphere plugin and execute the exact same command as with the retrieved kubeconfig from above. Logically the output is exactly the same.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl-vsphere login --vsphere-username administrator@vsphere.local --server<span style="color:#f92672">=</span>10.10.0.64 --insecure-skip-tls-verify --tanzu-kubernetes-cluster-name tmc-tkg --tanzu-kubernetes-cluster-namespace adess1

$ kubectl get namespaces
NAME                           STATUS   AGE
default                        Active   149m
kube-node-lease                Active   149m
kube-public                    Active   149m
kube-system                    Active   149m
vmware-system-auth             Active   149m
vmware-system-cloud-provider   Active   149m
vmware-system-csi              Active   149m
vmware-system-tmc              Active   149m
</code></pre></div><p>I am impressed how easy and straight forward this was to implement. TMC provides a centralized control plane for all Kubernetes Clusters running in the Cloud or On Premises and a graphical interface to provision and manage all your Clusters. Right now we see that TMC really helps to keep an easy and streamlined appraoch to enable Development teams in gaining more flexibility while ensuring a safe and secure environment applied by policies of the operators. I am really excited what´s coming next :-)!</p>
<p>As usual feedback is welcome and feel free to reach out in case you found errors or have suggestions.</p>
<p><strong>Links:</strong></p>
<ul>
<li><a href="https://kb.vmware.com/s/article/80727">The official KB</a></li>
<li><a href="https://console.cloud.vmware.com/">VMware Cloud Console</a></li>
<li><a href="https://alexdess.cloud/posts/tmconvmc/">My previous Post about Tanzu Mission Control</a></li>
</ul>





<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1607011983"></script>
    <script src="/js/perfect-scrollbar.min.js?1607011983"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1607011983"></script>
    <script src="/js/jquery.sticky.js?1607011983"></script>
    <script src="/js/featherlight.min.js?1607011983"></script>
    <script src="/js/highlight.pack.js?1607011983"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1607011983"></script>
    <script src="/js/learn.js?1607011983"></script>
    <script src="/js/hugo-learn.js?1607011983"></script>
    
        
            <script src="/mermaid/mermaid.js?1607011983"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-146538348-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
